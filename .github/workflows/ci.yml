name: CI Build

on:
  push:
    branches: [ actions_tests ]

jobs:
  mac_build:
    runs-on: macOS-11.0
    name: macOS 11 Big Sur Build
    env:
      QTDIR: /usr/local/opt/qt
    steps:
      - name: Checkout Source
        uses: actions/checkout@v2
      - name: Pre-build setup
        run: |
          set -x
          brew update
          brew install qt5
          $QTDIR/bin/qmake -v
          clang -v
          gcc -v
      - name: Build
        run: |
          export PATH=$QTDIR/bin:$PATH
          export VERSION=`cat Software/VERSION`
          cd Software
          ./update_locales.sh
          qmake -r
          make
      - name: Package DMG
        run: $QTDIR/bin/macdeployqt Software/bin/Prismatik.app -dmg
      - name: Check DMG
        run: |
          set -x
          ls Software/bin
          hdiutil attach Software/bin/Prismatik.dmg
          ls /Volumes/Software/bin:Prismatik/Prismatik.app
          otool -L /Volumes/Software/bin:Prismatik/Prismatik.app/Contents/MacOS/Prismatik
          otool -L /Volumes/Software/bin:Prismatik/Prismatik.app/Contents/Frameworks/QtWidgets.framework/Versions/5/QtWidgets
          hdiutil detach /Volumes/Software/bin:Prismatik
